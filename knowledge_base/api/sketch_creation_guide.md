# Sketch Creation Guide - Real Working Examples

## Overview

This guide is based on REAL working features from the display cabinets document. These are the exact JSON structures that Onshape accepts and uses.

## Key Discovery: Sketch Structure

### What We Got WRONG

Our original builder created:
```json
{
  "btType": "BTMFeature-134",
  "feature": {
    "btType": "BTMSketch-151",
    ...
  }
}
```

### What ACTUALLY Works

```json
{
  "btType": "BTMSketch-151",
  "featureType": "newSketch",
  "name": "back panel",
  "featureId": "FWXtkjgpR9vOAbK_0",  // Generated by Onshape
  "suppressed": false,
  "namespace": "",
  "returnAfterSubfeatures": false,
  "subFeatures": [],
  "suppressionState": null,
  "parameterLibraries": [],
  "nodeId": "vBH/27Q9dU4V24nL",  // Generated by Onshape
  "parameters": [...],
  "entities": [...],
  "constraints": [...]
}
```

**Critical Differences:**
1. ❌ NO nested "feature" object
2. ✅ BTMSketch-151 is the TOP-LEVEL type
3. ✅ Has `featureType: "newSketch"` field
4. ✅ Has `featureId` (we don't provide this, Onshape generates it)
5. ✅ Has `nodeId` on every parameter and constraint

## Sketch Plane Parameter

```json
{
  "btType": "BTMParameterQueryList-148",
  "parameterId": "sketchPlane",
  "queries": [
    {
      "btType": "BTMIndividualQuery-138",
      "deterministicIds": ["JCC"],  // Front plane
      "queryStatement": null,
      "nodeId": "FdcWhJ6fr8B4gTD"
    }
  ],
  "filter": {
    "btType": "BTOrFilter-167",
    ...
  },
  "nodeId": "TbS11nOjvtm6ro4r",
  "parameterName": "",
  "libraryRelationType": "NONE"
}
```

### Standard Plane IDs
- **Front**: `JCC`
- **Top**: `JDC`
- **Right**: `JEC`

## Entities (Geometry)

A rectangle is made of 4 line segments:

```json
{
  "btType": "BTMSketchCurveSegment-155",
  "entityId": "AjpZLHQCiR3I.bottom",
  "geometry": {
    "btType": "BTCurveGeometryLine-117",
    "pntX": -0.023276226103849884,
    "pntY": 0.8524875000000001,
    "dirX": 1.0,
    "dirY": 1.8369701987210297e-16
  },
  "startPointId": "AjpZLHQCiR3I.bottom.start",
  "endPointId": "AjpZLHQCiR3I.bottom.end",
  "startParam": -0.4783737738961498,
  "endParam": 0.5249262261038499,
  "isConstruction": false,
  "nodeId": "MWdZcyfbRrYS1VKYr",
  "index": 1,
  "parameters": [],
  "namespace": "",
  "name": "",
  "internalIds": [],
  "centerId": "",
  "offsetCurveExtensions": [],
  "isFromEndpointSplineHandle": false,
  "isFromSplineHandle": false,
  "isFromSplineControlPolygon": false
}
```

### Entity IDs Pattern
- `AjpZLHQCiR3I.bottom` - main line ID
- `AjpZLHQCiR3I.bottom.start` - start point ID
- `AjpZLHQCiR3I.bottom.end` - end point ID

The base ID (`AjpZLHQCiR3I`) appears to be randomly generated.

## Constraints

### Dimensional Constraints (Length)

```json
{
  "btType": "BTMSketchConstraint-2",
  "entityId": "EVyXR2L6jY1V",
  "constraintType": "LENGTH",
  "index": 1,
  "nodeId": "M4pYEsaooZNB/8M5L",
  "namespace": "",
  "name": "",
  "parameters": [
    {
      "btType": "BTMParameterString-149",
      "value": "AjpZLHQCiR3I.bottom",  // References entity
      "parameterId": "localFirst",
      "nodeId": "MeT6oqKrfLQ6w8eLu",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterEnum-145",
      "enumName": "DimensionDirection",
      "value": "MINIMUM",
      "parameterId": "direction",
      "nodeId": "M4ho+i2QPtgtApXwj",
      "namespace": "",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterQuantity-147",
      "isInteger": false,
      "value": 0.0,
      "units": "",
      "expression": "#side_cabinet_width",  // Variable reference!
      "parameterId": "length",
      "nodeId": "MzrP9unSq4BrFMKv4",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterEnum-145",
      "enumName": "DimensionAlignment",
      "value": "ALIGNED",
      "parameterId": "alignment",
      "nodeId": "MkyhGnGoh0xIInBmL",
      "namespace": "",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterQuantity-147",
      "expression": "0.520062396137484",
      "parameterId": "labelRatio",
      "nodeId": "M92LzAX88zaK89up+"
    },
    {
      "btType": "BTMParameterQuantity-147",
      "expression": "-0.043852560595468854*m",
      "parameterId": "labelDistance",
      "nodeId": "MfJUvxfihInV7T2w1"
    }
  ],
  "hasOffsetData1": false,
  "offsetOrientation1": false,
  "offsetDistance1": 0.0,
  "hasOffsetData2": false,
  "offsetOrientation2": false,
  "offsetDistance2": 0.0,
  "hasPierceParameter": false,
  "pierceParameter": 0.0,
  "helpParameters": []
}
```

**Variable Reference Format:** `#side_cabinet_width`

### Distance Constraints (Centering)

To center the sketch on the origin using planes:

```json
{
  "btType": "BTMSketchConstraint-2",
  "constraintType": "DISTANCE",
  "parameters": [
    {
      "btType": "BTMParameterQueryList-148",
      "parameterId": "externalFirst",  // Reference to plane
      "queries": [
        {
          "btType": "BTMIndividualQuery-138",
          "deterministicIds": ["JEC"]  // Right plane
        }
      ],
      "nodeId": "M52uX/48in77ctnyL",
      "filter": null,
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterString-149",
      "value": "AjpZLHQCiR3I.right",  // Sketch entity
      "parameterId": "localSecond",
      "nodeId": "MNH6cct65VGUp08Ui"
    },
    {
      "btType": "BTMParameterQuantity-147",
      "expression": "#side_cabinet_width/2",  // Half the width
      "parameterId": "length",
      "nodeId": "M/My3lCzIGQMONIZZ"
    }
  ]
}
```

This creates a constraint saying "the right edge of the sketch is half the width away from the Right plane", effectively centering it.

### Geometric Constraints

```json
{
  "btType": "BTMSketchConstraint-2",
  "constraintType": "PERPENDICULAR",
  "parameters": [
    {
      "btType": "BTMParameterString-149",
      "value": "AjpZLHQCiR3I.top",
      "parameterId": "localFirst"
    },
    {
      "btType": "BTMParameterString-149",
      "value": "AjpZLHQCiR3I.left",
      "parameterId": "localSecond"
    }
  ]
}
```

Common types:
- `PERPENDICULAR`
- `PARALLEL`
- `HORIZONTAL`
- `VERTICAL`
- `COINCIDENT` (for connecting corners)

## Thicken vs Extrude

The user used **Thicken** instead of Extrude:

```json
{
  "btType": "BTMFeature-134",
  "featureType": "thicken",
  "name": "Thicken 1",
  "featureId": "FVsfqYeclVHClNI_0",
  "nodeId": "6reOMPIo7XyyvQqu",
  "namespace": "",
  "suppressed": false,
  "returnAfterSubfeatures": false,
  "subFeatures": [],
  "suppressionState": null,
  "parameterLibraries": [],
  "parameters": [
    {
      "btType": "BTMParameterEnum-145",
      "enumName": "NewBodyOperationType",
      "value": "NEW",
      "parameterId": "operationType",
      "nodeId": "ChhYjGUHAYmetuvP",
      "namespace": "",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterQueryList-148",
      "parameterId": "entities",
      "queries": [
        {
          "btType": "BTMIndividualSketchRegionQuery-140",
          "featureId": "FWXtkjgpR9vOAbK_0",  // References sketch
          "filterInnerLoops": true,
          "queryString": "query = qSketchRegion(id + \"FWXtkjgpR9vOAbK_0\", true);",
          "deterministicIds": ["JGC"],
          "queryStatement": null,
          "nodeId": "MMtff1vyblC1hxsMy"
        }
      ],
      "nodeId": "DfHqlzMDM5k+C+Ro",
      "filter": {...}
    },
    {
      "btType": "BTMParameterQuantity-147",
      "expression": "#side_cabinet_wall_thickness",  // Variable!
      "parameterId": "thickness1",
      "nodeId": "leAZNjSFqhduDW6E",
      "isInteger": false,
      "value": 0.0,
      "units": "",
      "parameterName": "",
      "libraryRelationType": "NONE"
    },
    {
      "btType": "BTMParameterBoolean-144",
      "value": false,
      "parameterId": "oppositeDirection",
      "nodeId": "WsK2M2e/T3WkznUc",
      "parameterName": "",
      "libraryRelationType": "NONE"
    }
  ]
}
```

**Note:** BTMFeature-134 wrapper IS used for thicken/extrude (but NOT for sketch!)

## NodeIDs

Every parameter and entity needs a `nodeId`. These appear to be random strings like:
- `MWdZcyfbRrYS1VKYr`
- `M4pYEsaooZNB/8M5L`
- `FdcWhJ6fr8B4gTD`

**We need to generate these** (probably random base64-like strings).

## Next Steps for Implementation

1. ✅ Generate random nodeIds for all parameters
2. ✅ Use BTMSketch-151 at top level (not wrapped)
3. ✅ Add featureType field
4. ✅ Generate proper entity IDs
5. ✅ Include all required metadata fields
6. ✅ Test with simple rectangle first
7. ✅ Add variable references with # prefix
8. ✅ Add distance constraints for centering

## Minimum Viable Sketch

The absolute minimum for a working sketch:

```json
{
  "btType": "BTMSketch-151",
  "featureType": "newSketch",
  "name": "Test Sketch",
  "suppressed": false,
  "namespace": "",
  "parameters": [
    {
      "btType": "BTMParameterQueryList-148",
      "parameterId": "sketchPlane",
      "queries": [{
        "btType": "BTMIndividualQuery-138",
        "deterministicIds": ["JCC"]
      }]
    }
  ],
  "entities": [],
  "constraints": []
}
```

Even an empty sketch needs the plane parameter!
